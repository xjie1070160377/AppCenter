<%var style = {%>
<link rel="stylesheet" type="text/css" href="${session.guestbook}/_css/base.css" />
<link rel="stylesheet" type="text/css" href="${session.guestbook}/_css/globle.css" />
<link rel="stylesheet" type="text/css" href="${session.guestbook}/_css/three-quarters.css" />
<link rel="stylesheet" type="text/css" href="${session.guestbook}/_css/redmooc_topic.css" />
<link rel="stylesheet" type="text/css" href="${session.guestbook}/_css/redmooc_page.css" />
<link rel="stylesheet" type="text/css" href="${session.guestbook}/_css/messageList.css" />
<%};%>

<%include("shared/inc_head.html", {title:"已发信件", style:style}){} %> 
</head>	

<body class="output p-guestbook-sent <%if(isNotEmpty(session.token)){ %> app <%}%>">
	
	<%include("shared/inc_nav_side.html"){} %>
	<%include("shared/inc_nav_user.html"){} %>
	
	<!-- 内容 -->
	<div class="placehold f-dn">
		<div class="i-loading">
			<?xml version="1.0" encoding="utf-8"?><svg width='48px' height='48px' xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="uil-ring"><rect x="0" y="0" width="100" height="100" fill="none" class="bk"></rect><defs><filter id="uil-ring-shadow" x="-100%" y="-100%" width="300%" height="300%"><feOffset result="offOut" in="SourceGraphic" dx="0" dy="0"></feOffset><feGaussianBlur result="blurOut" in="offOut" stdDeviation="0"></feGaussianBlur><feBlend in="SourceGraphic" in2="blurOut" mode="normal"></feBlend></filter></defs><path d="M10,50c0,0,0,0.5,0.1,1.4c0,0.5,0.1,1,0.2,1.7c0,0.3,0.1,0.7,0.1,1.1c0.1,0.4,0.1,0.8,0.2,1.2c0.2,0.8,0.3,1.8,0.5,2.8 c0.3,1,0.6,2.1,0.9,3.2c0.3,1.1,0.9,2.3,1.4,3.5c0.5,1.2,1.2,2.4,1.8,3.7c0.3,0.6,0.8,1.2,1.2,1.9c0.4,0.6,0.8,1.3,1.3,1.9 c1,1.2,1.9,2.6,3.1,3.7c2.2,2.5,5,4.7,7.9,6.7c3,2,6.5,3.4,10.1,4.6c3.6,1.1,7.5,1.5,11.2,1.6c4-0.1,7.7-0.6,11.3-1.6 c3.6-1.2,7-2.6,10-4.6c3-2,5.8-4.2,7.9-6.7c1.2-1.2,2.1-2.5,3.1-3.7c0.5-0.6,0.9-1.3,1.3-1.9c0.4-0.6,0.8-1.3,1.2-1.9 c0.6-1.3,1.3-2.5,1.8-3.7c0.5-1.2,1-2.4,1.4-3.5c0.3-1.1,0.6-2.2,0.9-3.2c0.2-1,0.4-1.9,0.5-2.8c0.1-0.4,0.1-0.8,0.2-1.2 c0-0.4,0.1-0.7,0.1-1.1c0.1-0.7,0.1-1.2,0.2-1.7C90,50.5,90,50,90,50s0,0.5,0,1.4c0,0.5,0,1,0,1.7c0,0.3,0,0.7,0,1.1 c0,0.4-0.1,0.8-0.1,1.2c-0.1,0.9-0.2,1.8-0.4,2.8c-0.2,1-0.5,2.1-0.7,3.3c-0.3,1.2-0.8,2.4-1.2,3.7c-0.2,0.7-0.5,1.3-0.8,1.9 c-0.3,0.7-0.6,1.3-0.9,2c-0.3,0.7-0.7,1.3-1.1,2c-0.4,0.7-0.7,1.4-1.2,2c-1,1.3-1.9,2.7-3.1,4c-2.2,2.7-5,5-8.1,7.1 c-0.8,0.5-1.6,1-2.4,1.5c-0.8,0.5-1.7,0.9-2.6,1.3L66,87.7l-1.4,0.5c-0.9,0.3-1.8,0.7-2.8,1c-3.8,1.1-7.9,1.7-11.8,1.8L47,90.8 c-1,0-2-0.2-3-0.3l-1.5-0.2l-0.7-0.1L41.1,90c-1-0.3-1.9-0.5-2.9-0.7c-0.9-0.3-1.9-0.7-2.8-1L34,87.7l-1.3-0.6 c-0.9-0.4-1.8-0.8-2.6-1.3c-0.8-0.5-1.6-1-2.4-1.5c-3.1-2.1-5.9-4.5-8.1-7.1c-1.2-1.2-2.1-2.7-3.1-4c-0.5-0.6-0.8-1.4-1.2-2 c-0.4-0.7-0.8-1.3-1.1-2c-0.3-0.7-0.6-1.3-0.9-2c-0.3-0.7-0.6-1.3-0.8-1.9c-0.4-1.3-0.9-2.5-1.2-3.7c-0.3-1.2-0.5-2.3-0.7-3.3 c-0.2-1-0.3-2-0.4-2.8c-0.1-0.4-0.1-0.8-0.1-1.2c0-0.4,0-0.7,0-1.1c0-0.7,0-1.2,0-1.7C10,50.5,10,50,10,50z" fill="#ff570e" filter="url(#uil-ring-shadow)"><animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" repeatCount="indefinite" dur="1s"></animateTransform></path></svg>
		</div>
	</div>
	
	<div class="row-fluid clearfix">
		<!-- include("shared/inc_left_cover.html"){} -->
		
		<dl class="cover m-messageList">
			<dt class="m-messageList-top">
				<div class="header f-cb">
					<a href="javascript:history.go(-1)" title="返回" class="back"><i class="iconfont icon-back1"></i></a>
					<h3 class="f-fl">我的信件 </h3>
				</div>
				
				<ul class="topNav f-cb">
					<li class="active" data-state="">全部</li>
					<li data-state="1">已回复</li>
					<li data-state="0">未回复</li>
				</ul>
			</dt>
		</dl>
		
		
		<div class="contentBox m-mailInfo collections">
			
		</div>
		
		<%include("shared/inc_footer.html"){} %>
		
	</div>
<script src="${session.guestbook}/_js/jquery-2.1.4.min.js"></script>
<script src="${session.guestbook}/_js/lodash.min.js"" type="text/javascript" charset="utf-8"></script>
<script src="${session.guestbook}/_js/jquery.nicescroll.min.js" type="text/javascript" charset="utf-8"></script>
<script src="${session.guestbook}/_js/HashMap.js" type="text/javascript" charset="utf-8"></script>
<script src="${session.guestbook}/_js/app.js"></script>
<script id='template' type="text/html">
<@ if(typeof msgList == 'undefined'){window.msgList = new HashMap();}@>

<@ if(data.length == 0){@>
<dd class="no-mail f-dn">
	<img src="${session.guestbook}/_img/nodata_mail.jpg" alt="" />
	<a href="/widget/guestbook/addMsg" class="btn">立即写信</a>
</dd>
<@ } @>


<@ _.each(data, function(msg){ @>
<@ msgList.put(msg._id, msg); @>
	<dd class="message" id="{{msg._id}}" >  
		<span class="username">{{msg.username}}</span><span class="createTime f-fr">{{msg.createTime}}</span>
		<!--<span>[{{msg.guestbookType}}]</span>-->
		<p class="f-toe title">
			<a class="viewMsg"> 
              <!-- <i class="iconfont icon-flag state{{msg.isReply}}"></i>--> <@if(msg.isTop == 1){@> <em class="u-top">[置顶]</em> <@}@> {{msg.title}} 
            </a>
		</p>
		<p class="f-toe desc">{{msg.text}}</p>
	</dd>
<@ }) @>
</script>
<script id='template_msg'  type="text/html">

<dl class="m-info">
	<dt class="f-cb u-tt"><label for="">标题： </label><span>{{data.title}}</dt>
	<dd class="f-cb user"><label for="">发信人： </label><span>{{data.username}}</dd>
	<dd class="f-cb time"><label for="">时间：</label><span>{{data.createTime}}</span></dd>
	<dd class="f-cb text">
		<label for="">信件内容：</label>
		<span class="n-m-r-content">{{data.text}}</span>
	</dd>
</dl>	
	<@	function loop(data){
		if(!_.isEmpty(data.msgList)){
			_.each(data.msgList, function(child){ 
				if(child.type == "Reply"){
	@>				
				<dl class="m-info m-reply">
					<dt class="u-tt"><label for="">回复详情</label></dt>
					<dd class="f-cb user"><label for="">回复人： </label><span>{{child.username}}</dd>
					<dd class="f-cb time"><label for="">时间：</label><span>{{child.createTime}}</span></dd>
					<dd class="f-cb text">
						<label for="">回复内容：</label>
						<span class="n-m-r-content">{{child.text}}</span>
					</dd>
				</dl>
					
	<@			}else if(child.type == "Message"){		@>
					
				<dl class="m-info">
					<dt class="f-cb u-tt"><label for="">标题： </label><span>{{child.title}}</dt>
					<dd class="f-cb user"><label for="">发信人： </label><span style="color: #528eb3;">{{child.username}}</dd>
					<dd class="f-cb time"><label for="">时间：</label><span>{{child.createTime}}</span></dd>
					<dd class="f-cb text">
						<label for="">发信内容：</label>
						<span class="n-m-r-content">{{child.text}}</span>
					</dd>
				</dl>
				
	<@			}
				loop(child);
		    });
		}
	};
	loop(data);
	@>
	
<form id="validForm" class="m-mail-create appendForm" action="/widget/guestbook/appendMsg" method="post">
	<input type="hidden" class="parentId" name="parentId" value="{{data._id}}"/>
	<ul class="m-mail-items">
		<li class="u-item">
			<label for="">追加信件：</label>
			<textarea name="text" id="text" cols="70" rows="8" style="height: 258px;" title="请填写信息内容" required></textarea>
		</li>
		<div class="u-tips"><i class="iconfont">&#xe614;</i>友情提示:</span>您发布的信息需要管理员审核后才会在信箱信息中显示</div>
		<li class="m-submit"><a class="btn btn-success">提交</a></li>
	</ul>
</form>
	
</script>


<script>
	var page = 1,rows = 10 , userId="${userId}";
	
	(function init(){
		bindClick();
		getData({}, function(){
			if(!isMobile()){
				$(".message").eq(0).find(".viewMsg").trigger("click");
			}else{
				$(".placehold").fadeOut(200);
			}
		});
	})();
	
	function bindClick(){
		$(".btn-searchForm").on("click", function(){
			var columnField = "LIKE_title",
			keyWord = $("input[name='keyWord']").val();
			getData({columnField:columnField, keyWord:keyWord});
		});
		//tab切换
		$(".topNav li").on("click", function(){
			var self =$(this);
			self.addClass("active").siblings().removeClass("active");
			$(".m-messageList dd").remove();
			page = 1, columnField = "EQ_isReply";
			var isReply = self.attr("data-state");
			if(!_.isEmpty(isReply)){
				getData({"columnField": columnField, "keyWord": isReply, page:page}, true);
			}else{
				getData("", true);
			}
			
		});
		//显示留言
		$(".m-messageList").on("click", ".viewMsg", function(){
			var msg = $(this).parents(".message"),
				id = msg.attr("id"),	
				data = msgList.get(id);
			msg.addClass("active").siblings().removeClass("active");
			setTimeout(function(){
				render(data, $(".contentBox"), $("#template_msg").html(), false);
				if(isMobile()){
					$(".cover.m-messageList").toggle();$(".contentBox.m-mailInfo").toggle();
					$(".contentBox.m-mailInfo").prepend("<div class='back'><i class='iconfont icon-back1'></i>返回</div>");
				}
			}, 100)
		});
		//留言列表加载更多
		
		$(".cover.m-messageList").on("scroll",  _.throttle(function(){
			if(this.scrollTop + this.clientHeight >= this.scrollHeight - 10){
				//滚动条在底部
				getData();
			}
		}, 250));
		
		//手机返回
		$(".contentBox.m-mailInfo").on("click", ".icon-back1", function(){
			$(".cover.m-messageList").toggle();$(".contentBox.m-mailInfo").toggle();
		});
		
		//提交追加留言
		$(".row-fluid").on("click", ".m-submit", function(){
			var text = $("#text").val();
			if(_.isEmpty(text)){
				alert("内容不能为空");
			}else{
				var action = $("#validForm").attr("action"),
					postData = $("#validForm").serialize();
				console.log(action);
				console.log(postData);
				$.post(action, postData, function(data){
					if(data.resultStatus){
						location.reload();
					}else{
						console.log(data.resultMsg);
					}
				}, "json")
			}
		})
	}
	
	
	function afterRender(el,data){
		var html = '<dd class="bottom-loading-tips"><span class="text">没有更多了</span></dd>';
		if(data.rows.length > 0){
			html = '<dd class="bottom-loading-tips"><span class="three-quarters-loader">Loading…</span><span class="text">加载中……</span></dd>';
		}
		$(".bottom-loading-tips").remove();
		if(el.find(".message").length >= 10){
			el.append(html);
		}
	}
	//获取json数据
	function getData(searchParam, cb){
		var url = '/widget/guestbook/msgListJson',
		searchParam= _.extend({page : page,rows:rows, userId:userId}, searchParam);
		$.post(url, searchParam , function(data){
			console.log(data);
			if(data.resultStatus){
				page = data.page+1;
				setTimeout(function(){
					render(data.rows, $(".m-messageList"), $("#template").html(), true, function(){
						afterRender($(".cover.m-messageList"), data);
						if(cb){
							cb();
						}
					});
				}, 200);
			}
		},"json");
	}
	//渲染模板
	function render(data, container, template, append, cb){
		_.templateSettings.interpolate = /{{([\s\S]+?)}}/g;
		_.templateSettings.evaluate = /<@([\s\S]+?)@>/g;
		var compiled = _.template(template,  { 'imports': { 'HashMap': HashMap } });
		var result = compiled({ 'data': data, 'themeRoot':"${session.guestbook}" });
		if(append){
			container.append(result);
		}else{
			container.html(result);
		}
		if(cb){
			cb();
		}
	}
	
	/**
	**nicescroll
	**/
	$(function(){
		$('.row-fluid .cover').niceScroll({ 
		    cursorcolor: "#ccc",//#CC0071 光标颜色 
		    cursoropacitymax: .7, //改变不透明度非常光标处于活动状态（scrollabar“可见”状态），范围从1到0 
		    touchbehavior: false, //使光标拖动滚动像在台式电脑触摸设备 
		    cursorwidth: "8px", //像素光标的宽度 
		    cursorborder: "0", //     游标边框css定义 
		    cursorborderradius: "5px",//以像素为光标边界半径 
		    autohidemode: false //是否隐藏滚动条 
		});
	})
	
	function isMobile(){
		if(navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)){
			return true;
		}else{
			return false;
		}
	}
    

</script>


</body>
</html>